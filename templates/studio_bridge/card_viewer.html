{% extends "base.html" %}

{% block title %}You've received a MintKit card{% endblock %}
{% block main_class %}page-container mk-watermark mk-card-viewer-page{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">
      <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
        <div class="card-body p-4 p-md-5">

          <h1 class="h3 fw-bold mb-2">You've received a MintKit card</h1>
          <p class="text-muted mb-4">
            Use the QR code below to redeem, or share this page link.
          </p>

          {% if link.image_url %}
          <div class="rounded-4 overflow-hidden border mb-5" style="background:#fff;">
            <img
              src="{{ link.image_url }}"
              alt="Card preview"
              class="img-fluid w-100"
              style="display:block;max-width:100%;height:auto;"
            />
          </div>
          {% endif %}

          <div class="d-flex flex-wrap gap-2 mb-4">
            <a class="btn btn-primary px-4" href="#qr">Show QR code</a>
            <a class="btn btn-secondary px-4" href="/" rel="noopener">Visit MintKit Hub</a>
          </div>

          <div class="mt-4" id="qr">
            <h2 class="h5 fw-semibold mb-2">Redeem QR code</h2>

            {% comment %}
              Preferred: provide a server-generated QR as a data URL via qr_code_data_url.
              Fallback: generate a QR via qrserver only if no local QR is provided.
            {% endcomment %}

            {% if qr_code_data_url %}
              <img
                src="{{ qr_code_data_url }}"
                alt="QR code"
                class="img-fluid"
                style="max-width:320px;width:100%;height:auto;background:#fff;border-radius:12px;border:1px solid rgba(0,0,0,.08);padding:10px;image-rendering:pixelated;"
              />
            {% else %}
              {% with manual_code=link.manual_code|default:"" %}
                {% if manual_code %}
                  <img
                    src="https://api.qrserver.com/v1/create-qr-code/?size=320x320&data={{ manual_code|urlencode }}&format=png&ecc=Q"
                    alt="QR code"
                    class="img-fluid"
                    style="max-width:320px;width:100%;height:auto;background:#fff;border-radius:12px;border:1px solid rgba(0,0,0,.08);padding:10px;"
                  />
                {% elif link.nft_id %}
                  {% with mc="MANUAL-"|add:link.nft_id %}
                    <img
                      src="https://api.qrserver.com/v1/create-qr-code/?size=320x320&data={{ mc|urlencode }}&format=png&ecc=Q"
                      alt="QR code"
                      class="img-fluid"
                      style="max-width:320px;width:100%;height:auto;background:#fff;border-radius:12px;border:1px solid rgba(0,0,0,.08);padding:10px;"
                    />
                  {% endwith %}
                {% else %}
                  <div class="alert alert-secondary mb-0">QR code is not available for this card.</div>
                {% endif %}
              {% endwith %}
            {% endif %}

            <div class="mt-3 small text-muted">
              {% if link.manual_code %}
                <div class="mb-2">
                  Manual code:
                  <span
                    class="font-monospace d-block"
                    style="max-width:100%; overflow-wrap:anywhere; word-break:break-word;"
                  >{{ link.manual_code }}</span>
                </div>
              {% elif link.nft_id %}
                <div class="mb-2">
                  Manual code:
                  <span
                    class="font-monospace d-block"
                    style="max-width:100%; overflow-wrap:anywhere; word-break:break-word;"
                  >MANUAL-{{ link.nft_id }}</span>
                </div>
              {% endif %}

              {% if link.card_id %}
                <div class="mb-2">
                  Card ID:
                  <span
                    class="font-monospace d-block"
                    style="max-width:100%; overflow-wrap:anywhere; word-break:break-word;"
                  >{{ link.card_id }}</span>
                </div>
              {% elif link.nft_id %}
                <div class="mb-2">
                  Card ID:
                  <span
                    class="font-monospace d-block"
                    style="max-width:100%; overflow-wrap:anywhere; word-break:break-word;"
                  >{{ link.nft_id }}</span>
                </div>
              {% endif %}
            </div>
          </div>

          <hr class="my-4">

          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="small text-muted">
              Need help? Contact <a href="mailto:support@mintkit.co.uk">support@mintkit.co.uk</a>
            </div>

            {% if link.status %}
              <span class="badge rounded-pill
                {% if link.status|lower == 'active' %}bg-success
                {% elif link.status|lower == 'sent' %}bg-primary
                {% elif link.status|lower == 'redeemed' %}bg-danger
                {% else %}bg-secondary{% endif %}">
                {{ link.status|capfirst }}
              </span>
            {% endif %}
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
