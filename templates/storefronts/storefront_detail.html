{% extends "base.html" %}
{% load static %}

{# Disable the base wrapper styling for this one page #}
{% block main_class %}storefront-public-main{% endblock %}

{% block content %}

<style>
  /* Base wrapper is still present, but has no container styling on this page */
  .storefront-public-main{
    padding: 0;
    margin: 0;
    max-width: none;
    background: transparent;
    border: 0;
    box-shadow: none;
  }
</style>

<div id="sf-public-surface"
     class="storefront-public-card"
     style="position: relative; overflow: hidden;">

  {% if storefront.logo %}
    <div class="storefront-public-logo" data-sf-block="logo" data-sf-label="Logo">
      <img src="{{ storefront.logo.url }}" alt="{{ storefront.headline }} logo">
    </div>
  {% endif %}

  <h1 class="storefront-public-title" data-sf-block="headline" data-sf-label="Headline">
    {{ storefront.headline|default:"Storefront" }}
  </h1>

  {% if storefront.description %}
    <p class="storefront-public-body" data-sf-block="description" data-sf-label="Description">
      {{ storefront.description }}
    </p>
  {% endif %}

  {% if storefront.contact_details %}
    <h2 class="storefront-public-section-title" data-sf-block="contact_title" data-sf-label="Contact title">
      Contact details
    </h2>
    <p class="storefront-public-body" data-sf-block="contact_text" data-sf-label="Contact text">
      {{ storefront.contact_details }}
    </p>
  {% endif %}

  {% if has_cards %}
    <h2 class="storefront-public-section-title" data-sf-block="cards_title" data-sf-label="Featured cards title">
      Featured digital cards
    </h2>

    <div class="sf-card-grid" data-sf-block="cards_grid" data-sf-label="Cards grid">
      {% for card in storefront.cards.all %}
        <article class="sf-card">
          {% if card.image_url %}
            <div class="sf-card-image-wrap">
              <img src="{{ card.image_url }}" alt="{{ card.title|default:'Card' }}">
            </div>
          {% endif %}

          <h4 class="sf-card-title">
            {{ card.title|default:"Card " }}{% if not card.title %}{{ forloop.counter }}{% endif %}
            {% if card.price_label %}
              <span class="sf-card-price">{{ card.price_label }}</span>
            {% endif %}
          </h4>

          {% if card.description %}
            <p class="sf-card-text">{{ card.description }}</p>
          {% endif %}

          {% if card.buy_url %}
            <a href="{{ card.buy_url }}" target="_blank" rel="noopener"
               class="btn btn-sm btn-primary storefront-preview-card-button">
              Buy now
            </a>
          {% endif %}
        </article>
      {% endfor %}
    </div>
  {% endif %}
</div>

{# Expecting layout_data to be: {"layout": {...}, "styles": {...}, "bg": "#rrggbb"} #}
{{ layout_data|json_script:"sf-public-layout-data" }}

<script>
(function () {
  const dataEl = document.getElementById("sf-public-layout-data");
  const surface = document.getElementById("sf-public-surface");
  if (!dataEl || !surface) return;

  let data;
  try { data = JSON.parse(dataEl.textContent || "{}"); }
  catch { return; }

  const layout = data.layout || {};
  const styles = data.styles || {};
  const bg = data.bg || "#ffffff";

  // Apply background
  surface.style.background = bg;
  surface.style.position = "relative";

  // --- Auto-scale: if saved coords exceed the current surface width, scale down ---
  let maxRight = 0;
  let maxBottom = 0;

  Object.keys(layout).forEach((key) => {
    const l = layout[key] || {};
    const x = Number(l.x || 0);
    const y = Number(l.y || 0);
    const w = Number(l.w || 0);
    const h = Number(l.h || 0);
    maxRight = Math.max(maxRight, x + w);
    maxBottom = Math.max(maxBottom, y + h);
  });

  const surfaceWidth = surface.clientWidth || 1;
  const scale = (maxRight > surfaceWidth && maxRight > 0)
    ? (surfaceWidth / maxRight)
    : 1;

  function applyTextStyles(container, st) {
    if (!container) return;

    const px = st.fontSize ? (st.fontSize + "px") : "";
    container.style.fontFamily = st.fontFamily || "";
    container.style.fontSize = px;
    container.style.fontWeight = st.bold ? "700" : "";
    container.style.fontStyle = st.italic ? "italic" : "";
    container.style.textDecoration = st.underline ? "underline" : "";

    // Force same styling onto inner text elements (prevents h1/h2 defaults overriding)
    const textNodes = container.querySelectorAll("h1,h2,h3,h4,h5,h6,p,span,a,small,li,label,strong,em");
    textNodes.forEach((el) => {
      el.style.fontFamily = st.fontFamily || "";
      el.style.fontSize = px;
      el.style.fontWeight = st.bold ? "700" : "";
      el.style.fontStyle = st.italic ? "italic" : "";
      el.style.textDecoration = st.underline ? "underline" : "";
    });
  }

  // Apply layout + styles
  surface.querySelectorAll("[data-sf-block]").forEach((el) => {
    const id = el.getAttribute("data-sf-block");
    const l = layout[id];
    const st = styles[id] || {};

    if (st.hidden) {
      el.style.display = "none";
      return;
    } else {
      el.style.display = "";
    }

    if (l) {
      const x = Number(l.x || 0) * scale;
      const y = Number(l.y || 0) * scale;
      const w = Number(l.w || 0) * scale;
      const h = Number(l.h || 0) * scale;

      el.style.position = "absolute";
      el.style.left = x + "px";
      el.style.top = y + "px";
      if (w) el.style.width = w + "px";
      if (h) el.style.minHeight = h + "px";
      el.style.margin = "0";
    }

    applyTextStyles(el, st);
  });

  // Ensure surface is tall enough for positioned elements
  if (maxBottom > 0) {
    surface.style.minHeight = (Math.ceil(maxBottom * scale) + 40) + "px";
  }
})();
</script>

{% endblock %}
