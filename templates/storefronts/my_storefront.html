{% extends "base.html" %}

{% block content %}

<header class="sf-header">
  <div class="sf-header-main">
    <h1>My storefront</h1>
    <p class="text-muted">
      This is your public-facing page. Preview how it looks and update the details below.
    </p>
  </div>

  <div class="sf-header-actions">
    {% if storefront.is_active %}
    <span class="sf-badge sf-badge-success">Listed in Explore</span>
    {% else %}
    <span class="sf-badge sf-badge-muted">Hidden from Explore</span>
    {% endif %}

    <a href="{{ public_url }}" target="_blank" rel="noopener" class="btn btn-primary">
      View public storefront
    </a>
  </div>
</header>

<div class="sf-grid">
  {# ================= LEFT: PREVIEW ================= #}
  <section class="sf-panel sf-panel-preview">
    <div class="sf-panel-heading">
      <h2>Preview</h2>
      <button type="button" class="sf-preview-edit-btn" id="sf-open-layout-editor">
        Edit layout
      </button>
    </div>

    {# Root wrapper we will clone into the layout editor #}
    <div id="sf-preview-card" class="sf-preview-card storefront-preview-root">

      <div class="sf-preview-logo storefront-public-logo">
        {% if storefront.logo %}
        <img src="{{ storefront.logo.url }}" alt="{{ storefront.headline }} logo" class="storefront-logo-large">
        {% endif %}
      </div>

      <div class="storefront-public-heading">
        <h3 class="sf-preview-headline">
          {{ storefront.headline|default:"Your storefront headline" }}
        </h3>
      </div>

      <div class="storefront-public-description">
        <p class="sf-preview-body">
          {{ storefront.description|default:"Add a short description of your service or products." }}
        </p>
      </div>

      <div class="storefront-public-contact">
        <h4 class="sf-preview-section-title">Contact details</h4>
        <p class="sf-preview-body">
          {{ storefront.contact_details|default:"Add contact details customers can use to find or reach you." }}
        </p>
      </div>

      {# Featured cards - shown inside the preview root so the editor can move them as a block #}
      {% if has_cards %}
      <div class="storefront-public-featured">
        <h3 class="storefront-section-heading">Featured digital cards</h3>

        <div class="sf-card-grid">
          {% for card in storefront.cards.all %}
          <article class="sf-card">
            {% if card.image_url %}
            <div class="sf-card-image-wrap">
              <img src="{{ card.image_url }}" alt="{{ card.title|default:'Card' }}">
            </div>
            {% endif %}

            <h4 class="sf-card-title">
              {{ card.title|default:"Card " }}{% if not card.title %}{{ forloop.counter }}{% endif %}
              {% if card.price_label %}
              <span class="sf-card-price">{{ card.price_label }}</span>
              {% endif %}
            </h4>

            {% if card.description %}
            <p class="sf-card-text">{{ card.description }}</p>
            {% endif %}

            {% if card.buy_url %}
            <a href="{{ card.buy_url }}" target="_blank" rel="noopener"
               class="btn btn-sm btn-primary storefront-preview-card-button">
              Buy now
            </a>
            {% endif %}
          </article>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <p class="text-muted sf-preview-url">
      Customers will see this page at
      <a href="{{ public_url }}" target="_blank" rel="noopener">
        {{ public_url }}
      </a>.
    </p>
  </section>

  {# ================= RIGHT: EDIT FORM ================= #}
  <section class="sf-panel">
    <h2>Edit storefront details</h2>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      {{ form.non_field_errors }}

      {# Category + region row #}
      <div class="form-row storefront-form-row">
        <div class="form-group storefront-form-group">
          <label for="{{ form.business_category.id_for_label }}">
            Business Category <span class="text-danger">*</span>
          </label>
          {{ form.business_category }}
          {% if form.business_category.help_text %}
          <div class="sf-form-help">
            {{ form.business_category.help_text }}
          </div>
          {% endif %}
          {{ form.business_category.errors }}
        </div>

        <div class="form-group storefront-form-group">
          <label for="{{ form.region.id_for_label }}">
            Region <span class="text-danger">*</span>
          </label>
          {{ form.region }}
          {% if form.region.help_text %}
          <div class="sf-form-help">
            {{ form.region.help_text }}
          </div>
          {% endif %}
          {{ form.region.errors }}
        </div>
      </div>
      <hr class="sf-form-divider">

      {# Logo upload #}
      <div class="sf-form-row sf-logo-row">
        <label for="{{ form.logo.id_for_label }}">Storefront logo:</label>

        {% if storefront.logo %}
        <div class="sf-logo-current">
          <img src="{{ storefront.logo.url }}" alt="{{ storefront.headline|default:'Storefront logo' }}">
          <div class="sf-form-help">
            This logo appears above the preview on the left and on your public page.
            <p class="text-muted small">
              To change your logo, upload a new file and click <em>Save storefront</em>.
              If you leave this field empty, your current logo will stay the same.
            </p>
          </div>
        </div>
        {% endif %}

        {{ form.logo }}
      </div>

      {# Headline #}
      <p class="text-muted">
        Update the text shown on your public page. You can toggle public visibility here as well.
      </p>
      <div class="sf-form-row">
        <label for="{{ form.headline.id_for_label }}">Storefront headline:</label>
        {{ form.headline }}
        <div class="sf-form-help">
          Shown as the main title of your storefront.
        </div>
      </div>

      {# Description #}
      <div class="sf-form-row">
        <label for="{{ form.description.id_for_label }}">Description:</label>
        {{ form.description }}
        <div class="sf-form-help">
          Appears as the main body text on your storefront page.
        </div>
      </div>

      {# Contact details #}
      <div class="sf-form-row">
        <label for="{{ form.contact_details.id_for_label }}">Contact details:</label>
        {{ form.contact_details }}
        <div class="sf-form-help">
          These details help customers contact or find you.
        </div>
      </div>

      {# Public toggle #}
      <div class="sf-form-row sf-form-row-public">
        <div class="sf-form-inline">
          <label class="sf-checkbox-label">
            {{ form.is_active }}
            <span>Make my storefront public</span>
          </label>
        </div>
        <div class="sf-form-help">
          Tick this when you're ready for customers to see your page (and list it in Explore).
        </div>
      </div>

      {# ========= Featured cards - collapsible formset ========= #}
      {{ card_formset.management_form }}
      <details class="sf-card-formset-wrapper">
        <summary class="sf-card-summary">
          Featured digital cards (optional)
        </summary>

        <p class="text-muted small">
          Add up to three MintKit cards to highlight on your storefront.
          Paste the <code>thumbnail.webp</code> image URL and the link customers should use to buy.
          These cards will appear in the Preview on the left and on your public storefront.
        </p>

        <div class="sf-card-formset">
          {% for card_form in card_formset %}
          <div class="sf-card-form">
            <h4 class="sf-card-form-title">Card {{ forloop.counter }}</h4>

            {{ card_form.id }}

            <div class="form-row">
              <label for="{{ card_form.title.id_for_label }}">Card title</label>
              {{ card_form.title }}
            </div>

            <div class="form-row">
              <label for="{{ card_form.price_label.id_for_label }}">Price label (optional)</label>
              {{ card_form.price_label }}
            </div>

            <div class="form-row">
              <label for="{{ card_form.buy_url.id_for_label }}">Buy / details link</label>
              {{ card_form.buy_url }}
            </div>

            <div class="form-row">
              <label for="{{ card_form.image_url.id_for_label }}">Thumbnail image URL</label>
              {{ card_form.image_url }}
            </div>

            <div class="form-row">
              <label for="{{ card_form.description.id_for_label }}">Short description (optional)</label>
              {{ card_form.description }}
            </div>

            <div class="form-row form-row-checkbox">
              <label>
                {{ card_form.DELETE }}
                Remove this card from your storefront
              </label>
            </div>
          </div>
          {% endfor %}
        </div>
      </details>

      {# Actions #}
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save storefront</button>
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>
      </div>
    </form>
  </section>
</div>

{# ========== Full-screen layout editor overlay ========== #}
<div id="sf-layout-editor" class="sf-layout-editor-overlay" aria-hidden="true">
  <div class="sf-layout-editor-backdrop"></div>
  <div class="sf-layout-editor-dialog" role="dialog" aria-modal="true" aria-labelledby="sf-layout-editor-title">
    <header class="sf-layout-editor-header">
      <h2 id="sf-layout-editor-title">Customize storefront layout</h2>
      <button type="button" class="sf-layout-editor-close" id="sf-close-layout-editor" aria-label="Close layout editor">
        &times;
      </button>
    </header>

    <div class="sf-layout-editor-body">
      <div class="sf-layout-editor-canvas">
        {# JS will inject a cloned copy of the preview card here #}
        <div class="sf-layout-editor-surface" id="sf-layout-editor-surface"></div>
      </div>

      <p class="sf-layout-editor-hint text-muted">
        Draft layout editor - you can drag the main blocks around here. Layout changes are not saved yet.
      </p>
    </div>
  </div>
</div>

{# ========== Layout editor scripts (interact.js + wiring) ========== #}

<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>

<script>
  (function () {
    const openBtn  = document.getElementById("sf-open-layout-editor");
    const closeBtn = document.getElementById("sf-close-layout-editor");
    const overlay  = document.getElementById("sf-layout-editor");
    const surface  = document.getElementById("sf-layout-editor-surface");
    const preview  = document.getElementById("sf-preview-card");

    if (!openBtn || !overlay || !surface || !preview) {
      return;
    }

    function makeBlocksDraggable(cloneRoot) {
      const blockSelectors = [
        ".storefront-public-logo",
        ".storefront-public-heading",
        ".storefront-public-description",
        ".storefront-public-contact",
        ".storefront-public-featured"
      ];

      blockSelectors.forEach(function (selector) {
        const el = cloneRoot.querySelector(selector);
        if (!el) return;

        el.classList.add("sf-layout-draggable");
        el.style.position = "relative";
        el.style.touchAction = "none";
        el.setAttribute("data-x", "0");
        el.setAttribute("data-y", "0");
      });

      // Enable dragging for all draggable blocks in the editor
      interact(".sf-layout-draggable").draggable({
        listeners: {
          move(event) {
            const target = event.target;
            const startX = parseFloat(target.getAttribute("data-x")) || 0;
            const startY = parseFloat(target.getAttribute("data-y")) || 0;

            const x = startX + event.dx;
            const y = startY + event.dy;

            target.style.transform = "translate(" + x + "px, " + y + "px)";
            target.setAttribute("data-x", x);
            target.setAttribute("data-y", y);
          }
        },
        inertia: true
      });
    }

    function openEditor(event) {
      event.preventDefault();

      // Fresh clone of the preview each time
      surface.innerHTML = "";
      const clone = preview.cloneNode(true);
      clone.id = "sf-preview-card-editor-clone";
      surface.appendChild(clone);

      makeBlocksDraggable(clone);

      overlay.classList.add("is-open");
      overlay.setAttribute("aria-hidden", "false");
    }

    function closeEditor(event) {
      if (event) {
        event.preventDefault();
      }
      overlay.classList.remove("is-open");
      overlay.setAttribute("aria-hidden", "true");
    }

    openBtn.addEventListener("click", openEditor);

    if (closeBtn) {
      closeBtn.addEventListener("click", closeEditor);
    }

    // Close when clicking on the dimmed outer area
    overlay.addEventListener("click", function (event) {
      if (event.target === overlay) {
        closeEditor(event);
      }
    });

    // Close on Escape
    document.addEventListener("keydown", function (event) {
      if (event.key === "Escape" && overlay.classList.contains("is-open")) {
        closeEditor(event);
      }
    });
  })();
</script>

{% endblock %}
