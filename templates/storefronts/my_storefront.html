{% extends "base.html" %}

{% block content %}
<div class="page-container storefront-page">

  <!-- Header: title + Explore badge + public link -->
  <div class="storefront-page-header">
    <div>
      <h1 class="page-title">My storefront</h1>
      <p class="text-muted small">
        This is your public-facing page. Preview how it looks and update the details below.
      </p>
    </div>

    <div class="storefront-header-actions">
      {% if storefront.is_active %}
        <span class="badge-pill badge-success">Listed in Explore</span>
      {% else %}
        <span class="badge-pill badge-muted">Not listed in Explore</span>
      {% endif %}

      {% if public_url %}
        <a href="{{ public_url }}" class="btn btn-primary" target="_blank" rel="noopener">
          View public storefront
        </a>
      {% endif %}
    </div>
  </div>

  <div class="storefront-layout">

    <!-- LEFT: Preview -->
    <section class="storefront-preview card">
      <h2 class="card-title">Preview</h2>

      <div class="storefront-preview-body">
        {% if storefront.logo %}
          <img
            src="{{ storefront.logo.url }}"
            alt="{{ storefront.headline|default:storefront.profile.business_name }}"
            class="storefront-preview-logo"
          >
        {% endif %}

        <h3 class="storefront-preview-headline">
          {{ storefront.headline|default:"Your storefront headline" }}
        </h3>

        <p class="storefront-preview-description">
          {{ storefront.description|default:"Global digital card minting service with unbelievable features and functions not possible anywhere else." }}
        </p>

        <h4 class="storefront-preview-subtitle">Contact</h4>
        <p class="storefront-preview-contact">
          {{ storefront.contact_details|default:"Add some contact details so customers can reach you." }}
        </p>

        {% if cards %}
          <div class="storefront-preview-cards">
            <h4 class="storefront-preview-subtitle">Featured digital cards</h4>
            <div class="storefront-card-grid">
              {% for card in cards %}
                <article class="storefront-card">
                  {% if card.thumbnail_url %}
                    <div class="storefront-card-thumb-wrap">
                      <img src="{{ card.thumbnail_url }}" alt="{{ card.title }}" class="storefront-card-thumb">
                    </div>
                  {% endif %}

                  <div class="storefront-card-body">
                    <div class="storefront-card-header">
                      <h5 class="storefront-card-title">
                        {{ card.title|default:"Card title" }}
                      </h5>
                      {% if card.price_label %}
                        <span class="storefront-card-price">
                          {{ card.price_label }}
                        </span>
                      {% endif %}
                    </div>

                    {% if card.short_description %}
                      <p class="storefront-card-text">
                        {{ card.short_description }}
                      </p>
                    {% endif %}

                    {% if card.buy_link %}
                      <a href="{{ card.buy_link }}" target="_blank" rel="noopener"
                         class="btn btn-sm btn-primary">
                        Buy now
                      </a>
                    {% endif %}
                  </div>
                </article>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      </div>

      {% if public_url %}
        <p class="storefront-preview-url small text-muted">
          Customers will see this page at
          <br>
          <a href="{{ public_url }}" target="_blank" rel="noopener">{{ public_url }}</a>
        </p>
      {% endif %}
    </section>

    <!-- RIGHT: Edit form -->
    <section class="storefront-edit card">
      <form method="post" enctype="multipart/form-data" class="storefront-form">
        {% csrf_token %}

        <div class="storefront-edit-header">
          <h2 class="card-title">Edit storefront details</h2>

          <!-- “Make my storefront public” moved up next to heading -->
          <label class="storefront-public-toggle">
            {{ form.is_active }}
            <span>{{ form.is_active.label }}</span>
          </label>
        </div>

        <p class="text-muted small mb-3">
          Update the text shown on your public page. You can toggle public visibility here as well.
        </p>

        <!-- Logo -->
        <div class="form-row">
          <label>Storefront logo:</label>

          {% if storefront.logo %}
            <div class="storefront-logo-current">
              <img src="{{ storefront.logo.url }}"
                   alt="{{ storefront.headline|default:storefront.profile.business_name }}"
                   class="storefront-logo-inline">
            </div>
          {% endif %}

          {{ form.logo }}

          {% if form.logo.errors %}
            <div class="form-error">
              {{ form.logo.errors|striptags }}
            </div>
          {% endif %}

          <p class="text-muted small">
            This logo appears above the preview on the left and on your public page.
            To change your logo, upload a new file and click <strong>Save storefront</strong>.
          </p>
        </div>

        <!-- Headline -->
        <div class="form-row">
          <label for="{{ form.headline.id_for_label }}">Storefront headline:</label>
          {{ form.headline }}
          {% if form.headline.errors %}
            <div class="form-error">
              {{ form.headline.errors|striptags }}
            </div>
          {% endif %}
          <p class="text-muted small">
            Shown as the main title of your storefront.
          </p>
        </div>

        <!-- Description -->
        <div class="form-row">
          <label for="{{ form.description.id_for_label }}">Description:</label>
          {{ form.description }}
          {% if form.description.errors %}
            <div class="form-error">
              {{ form.description.errors|striptags }}
            </div>
          {% endif %}
          <p class="text-muted small">
            Appears as the main body text on your storefront page.
          </p>
        </div>

        <!-- Contact -->
        <div class="form-row">
          <label for="{{ form.contact_details.id_for_label }}">Contact details:</label>
          {{ form.contact_details }}
          {% if form.contact_details.errors %}
            <div class="form-error">
              {{ form.contact_details.errors|striptags }}
            </div>
          {% endif %}
          <p class="text-muted small">
            These details help customers contact or find you.
          </p>
        </div>

        <!-- Featured cards -->
        <hr class="mt-4 mb-3">

        <h3 class="card-subtitle">Featured digital cards (optional)</h3>
        <p class="text-muted small mb-3">
          Add up to three MintKit cards to highlight on your storefront. Paste the
          <code>thumbnail.webp</code> image URL and the link customers should use to buy.
        </p>

        {% if card_formset %}
          <div class="storefront-card-formset">
            {{ card_formset.management_form }}
            {% for card_form in card_formset %}
              <div class="card card-formset-item">
                <h4 class="card-formset-title">
                  Card {{ forloop.counter }}
                </h4>

                <div class="form-row">
                  <label>{{ card_form.title.label }}</label>
                  {{ card_form.title }}
                </div>

                <div class="form-row storefront-card-inline">
                  <div class="flex-1">
                    <label>{{ card_form.price_label.label }}</label>
                    {{ card_form.price_label }}
                  </div>
                  <div class="flex-1">
                    <label>{{ card_form.buy_link.label }}</label>
                    {{ card_form.buy_link }}
                  </div>
                </div>

                <div class="form-row">
                  <label>{{ card_form.thumbnail_url.label }}</label>
                  {{ card_form.thumbnail_url }}
                  <p class="text-muted small">
                    Example: <code>https://.../thumbnail.webp</code>
                  </p>
                </div>

                <div class="form-row">
                  <label>{{ card_form.short_description.label }}</label>
                  {{ card_form.short_description }}
                </div>

                {% if card_form.DELETE %}
                  <div class="form-row">
                    <label class="checkbox-inline">
                      {{ card_form.DELETE }} Remove this card
                    </label>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted small">
            Card editing isn't wired up yet, but this is where the forms will live.
          </p>
        {% endif %}

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Save storefront</button>
        </div>

      </form>
    </section>

  </div>
</div>
{% endblock %}
