{% extends "base.html" %}

{% block content %}

<header class="sf-header">
  <div class="sf-header-main">
    <h1>My storefront</h1>
    <p class="text-muted">
      This is your public-facing page. Preview how it looks and update the details below.
    </p>
  </div>

  <div class="sf-header-actions">
    {% if storefront.is_active %}
    <span class="sf-badge sf-badge-success">Listed in Explore</span>
    {% else %}
    <span class="sf-badge sf-badge-muted">Hidden from Explore</span>
    {% endif %}

    <a href="{{ public_url }}" target="_blank" rel="noopener" class="btn btn-primary">
      View public storefront
    </a>
  </div>
</header>

<div class="sf-grid">
  {# ================= LEFT: PREVIEW ================= #}
  <section class="sf-panel sf-panel-preview">
    <div class="sf-panel-heading">
      <h2>Preview</h2>
      <button type="button" class="sf-preview-edit-btn" id="sf-open-layout-editor">
        Edit layout
      </button>
    </div>

    <div class="sf-preview-card">
      <div class="sf-preview-logo">
        {% if storefront.logo %}
        <img src="{{ storefront.logo.url }}" alt="{{ storefront.headline }} logo" class="storefront-logo-large">
        {% endif %}
      </div>

      <h3 class="sf-preview-headline">
        {{ storefront.headline|default:"Your storefront headline" }}
      </h3>

      <p class="sf-preview-body">
        {{ storefront.description|default:"Add a short description of your service or products." }}
      </p>

      <h4 class="sf-preview-section-title">Contact details</h4>
      <p class="sf-preview-body">
        {{ storefront.contact_details|default:"Add contact details customers can use to find or reach you." }}
      </p>
    </div>

    {# Featured cards - preview #}
    {% if has_cards %}
    <h3 class="storefront-section-heading">Featured digital cards</h3>

    <div class="sf-card-grid">
      {% for card in storefront.cards.all %}
      <article class="sf-card">
        {% if card.image_url %}
        <div class="sf-card-image-wrap">
          <img src="{{ card.image_url }}" alt="{{ card.title|default:'Card' }}">
        </div>
        {% endif %}

        <h4 class="sf-card-title">
          {{ card.title|default:"Card " }}{% if not card.title %}{{ forloop.counter }}{% endif %}
          {% if card.price_label %}
          <span class="sf-card-price">{{ card.price_label }}</span>
          {% endif %}
        </h4>

        {% if card.description %}
        <p class="sf-card-text">{{ card.description }}</p>
        {% endif %}

        {% if card.buy_url %}
        <a href="{{ card.buy_url }}" target="_blank" rel="noopener"
          class="btn btn-sm btn-primary storefront-preview-card-button">
          Buy now
        </a>
        {% endif %}
      </article>
      {% endfor %}
    </div>
    {% endif %}

    <p class="text-muted sf-preview-url">
      Customers will see this page at
      <a href="{{ public_url }}" target="_blank" rel="noopener">
        {{ public_url }}
      </a>.
    </p>
  </section>

  {# ================= RIGHT: EDIT FORM ================= #}
  <section class="sf-panel">
    <h2>Edit storefront details</h2>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      {{ form.non_field_errors }}

      {# Category + region row #}
      <div class="form-row storefront-form-row">
        <div class="form-group storefront-form-group">
          <label for="{{ form.business_category.id_for_label }}">
            Business Category <span class="text-danger">*</span>
          </label>
          {{ form.business_category }}
          {% if form.business_category.help_text %}
          <div class="sf-form-help">
            {{ form.business_category.help_text }}
          </div>
          {% endif %}
          {{ form.business_category.errors }}
        </div>

        <div class="form-group storefront-form-group">
          <label for="{{ form.region.id_for_label }}">
            Region <span class="text-danger">*</span>
          </label>
          {{ form.region }}
          {% if form.region.help_text %}
          <div class="sf-form-help">
            {{ form.region.help_text }}
          </div>
          {% endif %}
          {{ form.region.errors }}
        </div>
      </div>

      <hr class="sf-form-divider">

      {# Logo upload #}
      <div class="sf-form-row sf-logo-row">
        <label for="{{ form.logo.id_for_label }}">Storefront logo:</label>

        {% if storefront.logo %}
        <div class="sf-logo-current">
          <img src="{{ storefront.logo.url }}" alt="{{ storefront.headline|default:'Storefront logo' }}">
          <div class="sf-form-help">
            This logo appears above the preview on the left and on your public page.
            <p class="text-muted small">
              To change your logo, upload a new file and click <em>Save storefront</em>.
              If you leave this field empty, your current logo will stay the same.
            </p>
          </div>
        </div>
        {% endif %}

        {{ form.logo }}
      </div>

      <p class="text-muted">
        Update the text shown on your public page. You can toggle public visibility here as well.
      </p>

      {# Headline #}
      <div class="sf-form-row">
        <label for="{{ form.headline.id_for_label }}">Storefront headline:</label>
        {{ form.headline }}
        <div class="sf-form-help">
          Shown as the main title of your storefront.
        </div>
      </div>

      {# Description #}
      <div class="sf-form-row">
        <label for="{{ form.description.id_for_label }}">Description:</label>
        {{ form.description }}
        <div class="sf-form-help">
          Appears as the main body text on your storefront page.
        </div>
      </div>

      {# Contact details #}
      <div class="sf-form-row">
        <label for="{{ form.contact_details.id_for_label }}">Contact details:</label>
        {{ form.contact_details }}
        <div class="sf-form-help">
          These details help customers contact or find you.
        </div>
      </div>

      {# Public toggle #}
      <div class="sf-form-row sf-form-row-public">
        <div class="sf-form-inline">
          <label class="sf-checkbox-label">
            {{ form.is_active }}
            <span>Make my storefront public</span>
          </label>
        </div>
        <div class="sf-form-help">
          Tick this when you're ready for customers to see your page (and list it in Explore).
        </div>
      </div>

      {# ========= Featured cards - collapsible formset ========= #}
      {{ card_formset.management_form }}
      <details class="sf-card-formset-wrapper">
        <summary class="sf-card-summary">
          Featured digital cards (optional)
        </summary>

        <p class="text-muted small">
          Add up to three MintKit cards to highlight on your storefront.
          Paste the <code>thumbnail.webp</code> image URL and the link customers should use to buy.
          These cards will appear in the Preview on the left and on your public storefront.
        </p>

        <div class="sf-card-formset">
          {% for card_form in card_formset %}
          <div class="sf-card-form">
            <h4 class="sf-card-form-title">Card {{ forloop.counter }}</h4>

            {{ card_form.id }}

            <div class="form-row">
              <label for="{{ card_form.title.id_for_label }}">Card title</label>
              {{ card_form.title }}
            </div>

            <div class="form-row">
              <label for="{{ card_form.price_label.id_for_label }}">Price label (optional)</label>
              {{ card_form.price_label }}
            </div>

            <div class="form-row">
              <label for="{{ card_form.buy_url.id_for_label }}">Buy / details link</label>
              {{ card_form.buy_url }}
            </div>

            <div class="form-row">
              <label for="{{ card_form.image_url.id_for_label }}">Thumbnail image URL</label>
              {{ card_form.image_url }}
            </div>

            <div class="form-row">
              <label for="{{ card_form.description.id_for_label }}">Short description (optional)</label>
              {{ card_form.description }}
            </div>

            <div class="form-row form-row-checkbox">
              <label>
                {{ card_form.DELETE }}
                Remove this card from your storefront
              </label>
            </div>
          </div>
          {% endfor %}
        </div>
      </details>

      {# Actions #}
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save storefront</button>
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>
      </div>
    </form>
  </section>
</div>

{# ========== Full-screen layout editor overlay ========== #}
<div id="sf-layout-editor" class="sf-layout-editor-overlay" aria-hidden="true">
  <div class="sf-layout-editor-backdrop"></div>
  <div class="sf-layout-editor-dialog" role="dialog" aria-modal="true" aria-labelledby="sf-layout-editor-title">
    <header class="sf-layout-editor-header">
      <h2 id="sf-layout-editor-title">Customize storefront layout</h2>
      <button type="button" class="sf-layout-editor-close" id="sf-close-layout-editor" aria-label="Close layout editor">
        &times;
      </button>
    </header>

    <div class="sf-layout-editor-body">
      <div class="sf-layout-editor-toolbar">
        <div class="sf-toolbar-group">
          <label for="sf-font-family">Font</label>
          <select id="sf-font-family">
            <option value="">Default</option>
            <option value="'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif">
              Clean sans
            </option>
            <option value="'Georgia', 'Times New Roman', serif">
              Elegant serif
            </option>
            <option value="'Trebuchet MS', system-ui, sans-serif">
              Modern
            </option>
            <option
              value="'Courier New', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace">
              Monospace
            </option>
          </select>
        </div>

        <div class="sf-toolbar-group">
          <label for="sf-font-size">Size (px)</label>
          <input id="sf-font-size" type="number" min="10" max="40" step="1" placeholder="Default">
        </div>

        <div class="sf-toolbar-group">
          <label>Style</label>
          <div class="sf-toolbar-inline-buttons">
            <button type="button" id="sf-font-bold" class="sf-toolbar-button sf-toolbar-button-toggle">
              <strong>B</strong>
            </button>
            <button type="button" id="sf-font-italic" class="sf-toolbar-button sf-toolbar-button-toggle">
              <em>I</em>
            </button>
            <button type="button" id="sf-font-underline" class="sf-toolbar-button sf-toolbar-button-toggle">
              <span style="text-decoration: underline;">U</span>
            </button>
          </div>
        </div>

        <div class="sf-toolbar-group">
          <label for="sf-bg-color">Background</label>
          <input id="sf-bg-color" type="color" value="#ffffff">
        </div>

        <div class="sf-toolbar-group" style="margin-left: auto;">
          <button type="button" id="sf-hide-block" class="sf-toolbar-button sf-toolbar-button-danger" disabled>
            Hide block
          </button>
          <button type="button" id="sf-reset-block" class="sf-toolbar-button" disabled>
            Reset styles
          </button>
        </div>
      </div>
      <br>
      <div class="sf-layout-editor-canvas">
        <div class="sf-layout-editor-surface">
          {# We reuse the same content as the main preview; JS will turn these into draggable/resizable blocks. #}
          <div class="sf-preview-card sf-preview-card--editor">
            <div class="sf-preview-logo">
              {% if storefront.logo %}
              <img src="{{ storefront.logo.url }}" alt="{{ storefront.headline }} logo" class="storefront-logo-large">
              {% endif %}
            </div>

            <h3 class="sf-preview-headline">
              {{ storefront.headline|default:"Your storefront headline" }}
            </h3>

            <p class="sf-preview-body">
              {{ storefront.description|default:"Add a short description of your service or products." }}
            </p>

            <h4 class="sf-preview-section-title">Contact details</h4>
            <p class="sf-preview-body">
              {{ storefront.contact_details|default:"Add contact details customers can use to find or reach you." }}
            </p>

            {% if has_cards %}
            <h3 class="storefront-section-heading">Featured digital cards</h3>

            <div class="sf-card-grid">
              {% for card in storefront.cards.all %}
              <article class="sf-card">
                {% if card.image_url %}
                <div class="sf-card-image-wrap">
                  <img src="{{ card.image_url }}" alt="{{ card.title|default:'Card' }}">
                </div>
                {% endif %}

                <h4 class="sf-card-title">
                  {{ card.title|default:"Card " }}{% if not card.title %}{{ forloop.counter }}{% endif %}
                  {% if card.price_label %}
                  <span class="sf-card-price">{{ card.price_label }}</span>
                  {% endif %}
                </h4>

                {% if card.description %}
                <p class="sf-card-text">{{ card.description }}</p>
                {% endif %}

                {% if card.buy_url %}
                <a href="{{ card.buy_url }}" target="_blank" rel="noopener"
                  class="btn btn-sm btn-primary storefront-preview-card-button">
                  Buy now
                </a>
                {% endif %}
              </article>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <p class="sf-layout-editor-hint text-muted">
        Draft layout editor - you can drag and resize the main blocks around here. Layout changes are not saved yet.
      </p>
    </div>
  </div>
</div>

{# ===== Layout editor styles (blocks + resize handle) - local to this template ===== #}
<style>
  /* Layout editor blocks: draggable + resizable */
  .sf-layout-editor-overlay .sf-layout-block {
    position: absolute;
    box-sizing: border-box;
    border-radius: 12px;
    border: 1px dashed rgba(129, 140, 248, 0.95);
    padding: 12px 16px 20px;
    background: rgba(255, 255, 255, 0.98);
    box-shadow: 0 12px 40px rgba(15, 23, 42, 0.18);
    cursor: grab;
    transition: box-shadow 0.12s ease, transform 0.12s ease;
    min-width: 220px;
    max-width: 90%;
    min-height: 72px;
    /* let blocks use their natural height; the canvas will scroll */
  }


  .sf-layout-editor-overlay .sf-layout-block-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: #6b7280;
    margin-bottom: 6px;
  }

  .sf-layout-editor-overlay .sf-layout-block--dragging,
  .sf-layout-editor-overlay .sf-layout-block--resizing {
    box-shadow: 0 18px 50px rgba(15, 23, 42, 0.26);
  }

  .sf-layout-editor-overlay .sf-layout-resize-handle {
    position: absolute;
    right: 10px;
    bottom: 10px;
    width: 14px;
    height: 14px;
    border-radius: 999px;
    border: 2px solid #4f46e5;
    background: #eef2ff;
    cursor: se-resize;
  }

  .sf-layout-editor-overlay .sf-layout-resize-handle::before {
    content: "";
    position: absolute;
    inset: 2px;
    border-right: 2px solid rgba(148, 163, 184, 0.9);
    border-bottom: 2px solid rgba(148, 163, 184, 0.9);
  }
</style>

<script>
  (function () {
    const openBtn = document.getElementById("sf-open-layout-editor");
    const closeBtn = document.getElementById("sf-close-layout-editor");
    const overlay = document.getElementById("sf-layout-editor");

    if (!openBtn || !overlay) return;

    let initialized = false;

    // Turn headline / logo / description / contact / cards into blocks
    function initLayoutBlocksAndToolbar() {
      if (initialized) return;

      const previewCard = overlay.querySelector(".sf-preview-card--editor");
      if (!previewCard) return;

      const canvas = previewCard;
      const canvasRect = canvas.getBoundingClientRect();
      const bodyBlocks = previewCard.querySelectorAll(".sf-preview-body");

      const config = [];

      // Logo
      const logoEl = previewCard.querySelector(".sf-preview-logo");
      if (logoEl) {
        config.push({ id: "logo", label: "Logo", elements: [logoEl] });
      }

      // Headline
      const headlineEl = previewCard.querySelector(".sf-preview-headline");
      if (headlineEl) {
        config.push({ id: "headline", label: "Headline", elements: [headlineEl] });
      }

      // Description paragraph
      if (bodyBlocks[0]) {
        config.push({
          id: "description",
          label: "Description",
          elements: [bodyBlocks[0]]
        });
      }

      // Contact title + body as separate blocks so you can hide just the text
      const contactTitleEl = previewCard.querySelector(".sf-preview-section-title");
      const contactBodyEl = bodyBlocks[1];

      if (contactTitleEl) {
        config.push({
          id: "contact-title",
          label: "Contact title",
          elements: [contactTitleEl]
        });
      }

      if (contactBodyEl) {
        config.push({
          id: "contact-body",
          label: "Contact text",
          elements: [contactBodyEl]
        });
      }

      // Featured cards: split heading + grid so heading alone can be hidden
      const cardsTitleEl = previewCard.querySelector(".storefront-section-heading");
      const cardsGridEl = previewCard.querySelector(".sf-card-grid");

      if (cardsTitleEl) {
        config.push({
          id: "cards-title",
          label: "Featured cards title",
          elements: [cardsTitleEl]
        });
      }

      if (cardsGridEl) {
        config.push({
          id: "cards-grid",
          label: "Cards grid",
          elements: [cardsGridEl]
        });
      }

      const items = [];

      // Wrap each group of elements in a draggable / resizable block
      config.forEach(function (blockConfig) {
        if (!blockConfig.elements.length) return;

        // Bounding box around all elements in this block
        let union = null;
        blockConfig.elements.forEach(function (el) {
          const r = el.getBoundingClientRect();
          if (!union) {
            union = { top: r.top, left: r.left, right: r.right, bottom: r.bottom };
          } else {
            union.top = Math.min(union.top, r.top);
            union.left = Math.min(union.left, r.left);
            union.right = Math.max(union.right, r.right);
            union.bottom = Math.max(union.bottom, r.bottom);
          }
        });

        if (!union) return;

        const padding = 16;
        let width = (union.right - union.left) + padding * 2;
        let height = (union.bottom - union.top) + padding * 2;
        let top = union.top - canvasRect.top - padding;
        let left = union.left - canvasRect.left - padding;

        // 10â€“20% breathing room, but keep inside canvas
        top = Math.max(8, top);
        left = Math.max(8, left);
        const maxWidth = canvasRect.width - 16;
        width = Math.min(width, maxWidth);

        const firstEl = blockConfig.elements[0];
        const parent = firstEl.parentNode;

        const block = document.createElement("div");
        block.className = "sf-layout-block";
        block.dataset.blockId = blockConfig.id;
        block.setAttribute("tabindex", "0");

        const labelEl = document.createElement("div");
        labelEl.className = "sf-layout-block-label";
        labelEl.textContent = blockConfig.label;

        const resizeHandle = document.createElement("button");
        resizeHandle.type = "button";
        resizeHandle.className = "sf-layout-resize-handle";
        resizeHandle.setAttribute("aria-label", "Resize " + blockConfig.label);

        parent.insertBefore(block, firstEl);
        block.appendChild(labelEl);

        blockConfig.elements.forEach(function (el) {
          block.appendChild(el);
        });

        block.appendChild(resizeHandle);

        Object.assign(block.style, {
          top: top + "px",
          left: left + "px",
          width: width + "px",
          height: height + "px"
        });

        items.push({ block: block, handle: resizeHandle });
      });

      canvas.style.position = "relative";
      canvas.style.minHeight = Math.max(canvasRect.height, 620) + "px";

      setupDragAndResize(canvas, items);
      initTextToolbar(canvas);

      initialized = true;
    }

    // Basic drag + resize logic
    function setupDragAndResize(canvas, items) {
      let active = null;

      function startInteraction(mode, event, block) {
        event.preventDefault();
        event.stopPropagation();

        const rect = block.getBoundingClientRect();
        const canvasRect = canvas.getBoundingClientRect();

        active = {
          mode: mode,
          block: block,
          startX: event.clientX,
          startY: event.clientY,
          startLeft: rect.left - canvasRect.left,
          startTop: rect.top - canvasRect.top,
          startWidth: rect.width,
          startHeight: rect.height,
          canvasRect: canvasRect
        };

        if (mode === "drag") {
          block.classList.add("sf-layout-block--dragging");
        } else {
          block.classList.add("sf-layout-block--resizing");
        }

        window.addEventListener("pointermove", onPointerMove);
        window.addEventListener("pointerup", endInteraction);
        window.addEventListener("pointercancel", endInteraction);
      }

      function onPointerMove(event) {
        if (!active) return;

        const dx = event.clientX - active.startX;
        const dy = event.clientY - active.startY;
        const minWidth = 160;
        const minHeight = 60;

        if (active.mode === "drag") {
          let left = active.startLeft + dx;
          let top = active.startTop + dy;

          const maxLeft = Math.max(0, active.canvasRect.width - active.startWidth);
          const maxTop = Math.max(0, active.canvasRect.height - active.startHeight);

          left = Math.min(Math.max(0, left), maxLeft);
          top = Math.min(Math.max(0, top), maxTop);

          active.block.style.left = left + "px";
          active.block.style.top = top + "px";
        } else if (active.mode === "resize") {
          let width = active.startWidth + dx;
          let height = active.startHeight + dy;

          width = Math.max(minWidth, Math.min(width, active.canvasRect.width - active.startLeft));
          height = Math.max(minHeight, Math.min(height, active.canvasRect.height - active.startTop));

          active.block.style.width = width + "px";
          active.block.style.height = height + "px";
        }
      }

      function endInteraction() {
        if (!active) return;

        active.block.classList.remove("sf-layout-block--dragging", "sf-layout-block--resizing");
        active = null;

        window.removeEventListener("pointermove", onPointerMove);
        window.removeEventListener("pointerup", endInteraction);
        window.removeEventListener("pointercancel", endInteraction);
      }

      items.forEach(function (item) {
        const block = item.block;
        const handle = item.handle;

        block.addEventListener("pointerdown", function (event) {
          if (event.button !== 0) return;
          if (event.target.classList.contains("sf-layout-resize-handle")) return;
          startInteraction("drag", event, block);
        });

        handle.addEventListener("pointerdown", function (event) {
          if (event.button !== 0) return;
          startInteraction("resize", event, block);
        });
      });
    }

    // Text styling toolbar: font, size, bold/italic/underline, background, hide/show
    function initTextToolbar(canvas) {
      const fontFamilySelect = document.getElementById("sf-font-family");
      const fontSizeInput = document.getElementById("sf-font-size");
      const boldBtn = document.getElementById("sf-font-bold");
      const italicBtn = document.getElementById("sf-font-italic");
      const underlineBtn = document.getElementById("sf-font-underline");
      const bgInput = document.getElementById("sf-bg-color");
      const hideButton = document.getElementById("sf-hide-block");
      const resetButton = document.getElementById("sf-reset-block");

      if (!fontFamilySelect || !fontSizeInput || !hideButton || !resetButton) return;

      const blocks = Array.from(canvas.querySelectorAll(".sf-layout-block"));
      if (!blocks.length) return;

      let currentBlock = null;

      function rgbToHex(color) {
        if (!color) return null;
        if (color.startsWith("#")) return color;
        const match = color.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
        if (!match) return null;
        const r = parseInt(match[1], 10);
        const g = parseInt(match[2], 10);
        const b = parseInt(match[3], 10);
        return "#" + [r, g, b].map(function (x) {
          return x.toString(16).padStart(2, "0");
        }).join("");
      }

      function updateToolbarFromBlock(block) {
        if (!block) {
          fontFamilySelect.value = "";
          fontSizeInput.value = "";
          if (bgInput) bgInput.value = "#ffffff";
          hideButton.disabled = true;
          resetButton.disabled = true;
          hideButton.textContent = "Hide block";
          [boldBtn, italicBtn, underlineBtn].forEach(function (btn) {
            if (btn) btn.classList.remove("is-active");
          });
          return;
        }

        fontFamilySelect.value = block.style.fontFamily || "";
        fontSizeInput.value = block.style.fontSize ? parseInt(block.style.fontSize, 10) : "";

        if (bgInput) {
          const currentBg = block.style.backgroundColor || "#ffffff";
          bgInput.value = rgbToHex(currentBg) || "#ffffff";
        }

        hideButton.disabled = false;
        resetButton.disabled = false;
        hideButton.textContent = block.classList.contains("sf-layout-block--hidden")
          ? "Show block"
          : "Hide block";

        if (boldBtn) {
          boldBtn.classList.toggle(
            "is-active",
            block.style.fontWeight === "700" || block.style.fontWeight === "bold"
          );
        }
        if (italicBtn) {
          italicBtn.classList.toggle("is-active", block.style.fontStyle === "italic");
        }
        if (underlineBtn) {
          underlineBtn.classList.toggle(
            "is-active",
            (block.style.textDecoration || "").indexOf("underline") !== -1
          );
        }
      }

      function selectBlock(block) {
        if (currentBlock === block) return;

        if (currentBlock) {
          currentBlock.classList.remove("sf-layout-block--selected");
        }

        currentBlock = block || null;

        if (currentBlock) {
          currentBlock.classList.add("sf-layout-block--selected");
        }

        updateToolbarFromBlock(currentBlock);
      }

      // Click to select a block (drag still works via pointerdown)
      blocks.forEach(function (block) {
        block.addEventListener("click", function (event) {
          if (event.target.classList.contains("sf-layout-resize-handle")) return;
          selectBlock(block);
        });
      });

      fontFamilySelect.addEventListener("change", function () {
        if (!currentBlock) return;
        currentBlock.style.fontFamily = this.value || "";
      });

      fontSizeInput.addEventListener("input", function () {
        if (!currentBlock) return;
        const value = parseInt(this.value, 10);
        currentBlock.style.fontSize = value ? value + "px" : "";
      });

      function toggleButton(button, applyFn) {
        if (!currentBlock || !button) return;
        button.classList.toggle("is-active");
        applyFn(button.classList.contains("is-active"));
      }

      if (boldBtn) {
        boldBtn.addEventListener("click", function () {
          toggleButton(boldBtn, function (on) {
            currentBlock.style.fontWeight = on ? "700" : "";
          });
        });
      }

      if (italicBtn) {
        italicBtn.addEventListener("click", function () {
          toggleButton(italicBtn, function (on) {
            currentBlock.style.fontStyle = on ? "italic" : "";
          });
        });
      }

      if (underlineBtn) {
        underlineBtn.addEventListener("click", function () {
          toggleButton(underlineBtn, function (on) {
            currentBlock.style.textDecoration = on ? "underline" : "";
          });
        });
      }

      if (bgInput) {
        bgInput.addEventListener("input", function () {
          if (!currentBlock) return;
          currentBlock.style.backgroundColor = this.value || "";
        });
      }

      hideButton.addEventListener("click", function () {
        if (!currentBlock) return;
        const isHidden = currentBlock.classList.toggle("sf-layout-block--hidden");
        hideButton.textContent = isHidden ? "Show block" : "Hide block";
      });

      resetButton.addEventListener("click", function () {
        if (!currentBlock) return;

        currentBlock.style.fontFamily = "";
        currentBlock.style.fontSize = "";
        currentBlock.style.fontWeight = "";
        currentBlock.style.fontStyle = "";
        currentBlock.style.textDecoration = "";
        currentBlock.style.backgroundColor = "";
        currentBlock.classList.remove("sf-layout-block--hidden");

        updateToolbarFromBlock(currentBlock);
      });

      const closeBtn = document.getElementById("sf-close-layout-editor");
      if (closeBtn) {
        closeBtn.addEventListener("click", function () {
          selectBlock(null);
        });
      }
    }

    function openEditor(event) {
      event.preventDefault();
      overlay.classList.add("is-open");
      document.body.classList.add("sf-layout-editor-open");
      // Wait for modal layout so measurements are correct
      window.setTimeout(initLayoutBlocksAndToolbar, 50);
    }

    function closeEditor(event) {
      if (event) event.preventDefault();
      overlay.classList.remove("is-open");
      document.body.classList.remove("sf-layout-editor-open");
    }

    openBtn.addEventListener("click", openEditor);

    if (closeBtn) {
      closeBtn.addEventListener("click", closeEditor);
    }

    overlay.addEventListener("click", function (event) {
      if (event.target === overlay) {
        closeEditor(event);
      }
    });

    document.addEventListener("keydown", function (event) {
      if (event.key === "Escape" && overlay.classList.contains("is-open")) {
        closeEditor(event);
      }
    });

    // In the editor, disable real navigation / button actions
    overlay.addEventListener("click", function (event) {
      if (event.target.closest(".sf-preview-card--editor a, .sf-preview-card--editor button")) {
        event.preventDefault();
      }
    });
  })();
</script>


{% endblock %}