{% extends "base.html" %}

{% block content %}

<header class="sf-header">
  <div class="sf-header-main">
    <h1>My storefront</h1>
    <p class="text-muted">
      This is your public-facing page. Preview how it looks and update the details below.
    </p>
  </div>

  <div class="sf-header-actions">
    {% if storefront.is_active %}
    <span class="sf-badge sf-badge-success">Listed in Explore</span>
    {% else %}
    <span class="sf-badge sf-badge-muted">Hidden from Explore</span>
    {% endif %}

    <a href="{{ public_url }}" target="_blank" rel="noopener" class="btn btn-primary">
      View public storefront
    </a>
  </div>
</header>

<div class="sf-grid">
  {# ================= LEFT: PREVIEW ================= #}
  <section class="sf-panel sf-panel-preview">
    <div class="sf-panel-heading">
      <h2>Preview</h2>
      <button type="button" class="sf-preview-edit-btn" id="sf-open-layout-editor">
        Edit layout
      </button>
    </div>

    <div class="sf-preview-card">
      <div class="sf-preview-logo">
        {% if storefront.logo %}
        <img src="{{ storefront.logo.url }}" alt="{{ storefront.headline }} logo" class="storefront-logo-large">
        {% endif %}
      </div>

      <h3 class="sf-preview-headline">
        {{ storefront.headline|default:"Your storefront headline" }}
      </h3>

      <p class="sf-preview-body">
        {{ storefront.description|default:"Add a short description of your service or products." }}
      </p>

      <h4 class="sf-preview-section-title">Contact details</h4>
      <p class="sf-preview-body">
        {{ storefront.contact_details|default:"Add contact details customers can use to find or reach you." }}
      </p>
    </div>

    {# Featured cards - preview #}
    {% if has_cards %}
    <h3 class="storefront-section-heading">Featured digital cards</h3>

    <div class="sf-card-grid">
      {% for card in storefront.cards.all %}
      <article class="sf-card">
        {% if card.image_url %}
        <div class="sf-card-image-wrap">
          <img src="{{ card.image_url }}" alt="{{ card.title|default:'Card' }}">
        </div>
        {% endif %}

        <h4 class="sf-card-title">
          {{ card.title|default:"Card " }}{% if not card.title %}{{ forloop.counter }}{% endif %}
          {% if card.price_label %}
          <span class="sf-card-price">{{ card.price_label }}</span>
          {% endif %}
        </h4>

        {% if card.description %}
        <p class="sf-card-text">{{ card.description }}</p>
        {% endif %}

        {% if card.buy_url %}
        <a href="{{ card.buy_url }}" target="_blank" rel="noopener"
          class="btn btn-sm btn-primary storefront-preview-card-button">
          Buy now
        </a>
        {% endif %}
      </article>
      {% endfor %}
    </div>
    {% endif %}

    <p class="text-muted sf-preview-url">
      Customers will see this page at
      <a href="{{ public_url }}" target="_blank" rel="noopener">
        {{ public_url }}
      </a>.
    </p>
  </section>

  {# ================= RIGHT: EDIT FORM ================= #}
  <section class="sf-panel">
    <h2>Edit storefront details</h2>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      {{ form.non_field_errors }}

      {# Category + region row #}
      <div class="form-row storefront-form-row">
        <div class="form-group storefront-form-group">
          <label for="{{ form.business_category.id_for_label }}">
            Business Category <span class="text-danger">*</span>
          </label>
          {{ form.business_category }}
          {% if form.business_category.help_text %}
          <div class="sf-form-help">
            {{ form.business_category.help_text }}
          </div>
          {% endif %}
          {{ form.business_category.errors }}
        </div>

        <div class="form-group storefront-form-group">
          <label for="{{ form.region.id_for_label }}">
            Region <span class="text-danger">*</span>
          </label>
          {{ form.region }}
          {% if form.region.help_text %}
          <div class="sf-form-help">
            {{ form.region.help_text }}
          </div>
          {% endif %}
          {{ form.region.errors }}
        </div>
      </div>

      <hr class="sf-form-divider">

      {# Logo upload #}
      <div class="sf-form-row sf-logo-row">
        <label for="{{ form.logo.id_for_label }}">Storefront logo:</label>

        {% if storefront.logo %}
        <div class="sf-logo-current">
          <img src="{{ storefront.logo.url }}" alt="{{ storefront.headline|default:'Storefront logo' }}">
          <div class="sf-form-help">
            This logo appears above the preview on the left and on your public page.
            <p class="text-muted small">
              To change your logo, upload a new file and click <em>Save storefront</em>.
              If you leave this field empty, your current logo will stay the same.
            </p>
          </div>
        </div>
        {% endif %}

        {{ form.logo }}
      </div>

      <p class="text-muted">
        Update the text shown on your public page. You can toggle public visibility here as well.
      </p>

      {# Headline #}
      <div class="sf-form-row">
        <label for="{{ form.headline.id_for_label }}">Storefront headline:</label>
        {{ form.headline }}
        <div class="sf-form-help">
          Shown as the main title of your storefront.
        </div>
      </div>

      {# Description #}
      <div class="sf-form-row">
        <label for="{{ form.description.id_for_label }}">Description:</label>
        {{ form.description }}
        <div class="sf-form-help">
          Appears as the main body text on your storefront page.
        </div>
      </div>

      {# Contact details #}
      <div class="sf-form-row">
        <label for="{{ form.contact_details.id_for_label }}">Contact details:</label>
        {{ form.contact_details }}
        <div class="sf-form-help">
          These details help customers contact or find you.
        </div>
      </div>

      {# Public toggle #}
      <div class="sf-form-row sf-form-row-public">
        <div class="sf-form-inline">
          <label class="sf-checkbox-label">
            {{ form.is_active }}
            <span>Make my storefront public</span>
          </label>
        </div>
        <div class="sf-form-help">
          Tick this when you're ready for customers to see your page (and list it in Explore).
        </div>
      </div>

      {# ========= Featured cards - collapsible formset ========= #}
      {{ card_formset.management_form }}
      <details class="sf-card-formset-wrapper">
        <summary class="sf-card-summary">
          Featured digital cards (optional)
        </summary>

        <p class="text-muted small">
          Add up to three MintKit cards to highlight on your storefront.
          Paste the <code>thumbnail.webp</code> image URL and the link customers should use to buy.
          These cards will appear in the Preview on the left and on your public storefront.
        </p>

        <div class="sf-card-formset">
          {% for card_form in card_formset %}
          <div class="sf-card-form">
            <h4 class="sf-card-form-title">Card {{ forloop.counter }}</h4>

            {{ card_form.id }}

            <div class="form-row">
              <label for="{{ card_form.title.id_for_label }}">Card title</label>
              {{ card_form.title }}
            </div>

            <div class="form-row">
              <label for="{{ card_form.price_label.id_for_label }}">Price label (optional)</label>
              {{ card_form.price_label }}
            </div>

            <div class="form-row">
              <label for="{{ card_form.buy_url.id_for_label }}">Buy / details link</label>
              {{ card_form.buy_url }}
            </div>

            <div class="form-row">
              <label for="{{ card_form.image_url.id_for_label }}">Thumbnail image URL</label>
              {{ card_form.image_url }}
            </div>

            <div class="form-row">
              <label for="{{ card_form.description.id_for_label }}">Short description (optional)</label>
              {{ card_form.description }}
            </div>

            <div class="form-row form-row-checkbox">
              <label>
                {{ card_form.DELETE }}
                Remove this card from your storefront
              </label>
            </div>
          </div>
          {% endfor %}
        </div>
      </details>

      {# Actions #}
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save storefront</button>
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>
      </div>
    </form>
  </section>
</div>

{# ========== Full-screen layout editor overlay ========== #}
<div id="sf-layout-editor" class="sf-layout-editor-overlay" aria-hidden="true">
  <div class="sf-layout-editor-backdrop" id="sf-layout-editor-backdrop"></div>

  <div class="sf-layout-editor-dialog" role="dialog" aria-modal="true" aria-labelledby="sf-layout-editor-title">
    <header class="sf-layout-editor-header">
      <h2 id="sf-layout-editor-title">Customize storefront layout</h2>
      <button type="button" class="sf-layout-editor-close" id="sf-close-layout-editor" aria-label="Close layout editor">
        &times;
      </button>
    </header>

    <div class="sf-layout-editor-body">
      <div class="sf-layout-editor-toolbar">
        <div class="sf-toolbar-group">
          <label for="sf-font-family">Font</label>
          <select id="sf-font-family">
            <option value="">Default</option>

            <!-- Sans -->
            <option value="'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif">Inter</option>
            <option value="'Roboto', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif">Roboto</option>
            <option value="'Poppins', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif">Poppins</option>
            <option value="'Montserrat', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif">Montserrat</option>
            <option value="'Lato', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif">Lato</option>
            <option value="'Nunito', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif">Nunito</option>
            <option value="'Open Sans', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif">Open Sans</option>

            <!-- Serif -->
            <option value="'Merriweather', Georgia, 'Times New Roman', serif">Merriweather</option>
            <option value="'Playfair Display', Georgia, 'Times New Roman', serif">Playfair Display</option>
            <option value="'PT Serif', Georgia, 'Times New Roman', serif">PT Serif</option>
            <option value="Georgia, 'Times New Roman', serif">Georgia</option>
            <option value="'Times New Roman', serif">Times New Roman</option>

            <!-- Display / Mono -->
            <option value="'Oswald', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif">Oswald</option>
            <option value="'Raleway', system-ui, -apple-system, 'Segoe UI', Arial, sans-serif">Raleway</option>
            <option value="'Fira Code', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace">Fira Code</option>
            <option value="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace">Monospace</option>
          </select>
        </div>

        <div class="sf-toolbar-group">
          <label for="sf-font-size">Size (px)</label>
          <input id="sf-font-size" type="number" min="10" max="96" step="1" placeholder="Default">
        </div>

        <div class="sf-toolbar-group">
          <label>Style</label>
          <div class="sf-toolbar-inline-buttons">
            <button type="button" id="sf-font-bold" class="sf-toolbar-button sf-toolbar-button-toggle" title="Bold">
              <strong>B</strong>
            </button>
            <button type="button" id="sf-font-italic" class="sf-toolbar-button sf-toolbar-button-toggle" title="Italic">
              <em>I</em>
            </button>
            <button type="button" id="sf-font-underline" class="sf-toolbar-button sf-toolbar-button-toggle" title="Underline">
              <span style="text-decoration: underline;">U</span>
            </button>
          </div>
        </div>

        <div class="sf-toolbar-group">
          <label for="sf-bg-color">Page background</label>
          <input id="sf-bg-color" type="color" value="#ffffff">
        </div>

        <div class="sf-toolbar-group" style="margin-left: auto;">
          <button type="button" id="sf-fit-toggle" class="sf-toolbar-button" title="Fit page into view">
            Fit
          </button>

          <button type="button" id="sf-hide-block" class="sf-toolbar-button sf-toolbar-button-danger" disabled>
            Hide block
          </button>
          <button type="button" id="sf-reset-block" class="sf-toolbar-button" disabled>
            Reset styles
          </button>
        </div>
      </div>

      {# Canvas is the scrollable area; surface is the “page” background we style. #}
      <div class="sf-layout-editor-canvas" id="sf-editor-canvas">
        <div class="sf-layout-editor-surface" id="sf-editor-surface">
          {# Editor content (normal flow) – JS will convert marked nodes into draggable blocks. #}
          <div class="sf-preview-card sf-preview-card--editor" id="sf-editor-content">
            <div class="sf-preview-logo" data-sf-block="logo" data-sf-label="Logo">
              {% if storefront.logo %}
              <img src="{{ storefront.logo.url }}" alt="{{ storefront.headline }} logo" class="storefront-logo-large">
              {% endif %}
            </div>

            <h3 class="sf-preview-headline" data-sf-block="headline" data-sf-label="Headline">
              {{ storefront.headline|default:"Your storefront headline" }}
            </h3>

            <p class="sf-preview-body" data-sf-block="description" data-sf-label="Description">
              {{ storefront.description|default:"Add a short description of your service or products." }}
            </p>

            <h4 class="sf-preview-section-title" data-sf-block="contact_title" data-sf-label="Contact title">
              Contact details
            </h4>

            <p class="sf-preview-body" data-sf-block="contact_text" data-sf-label="Contact text">
              {{ storefront.contact_details|default:"Add contact details customers can use to find or reach you." }}
            </p>

            {% if has_cards %}
            <h3 class="storefront-section-heading" data-sf-block="cards_title" data-sf-label="Featured cards title">
              Featured digital cards
            </h3>

            <div class="sf-card-grid" data-sf-block="cards_grid" data-sf-label="Cards grid">
              {% for card in storefront.cards.all %}
              <article class="sf-card">
                {% if card.image_url %}
                <div class="sf-card-image-wrap">
                  <img src="{{ card.image_url }}" alt="{{ card.title|default:'Card' }}">
                </div>
                {% endif %}

                <h4 class="sf-card-title">
                  {{ card.title|default:"Card " }}{% if not card.title %}{{ forloop.counter }}{% endif %}
                  {% if card.price_label %}
                  <span class="sf-card-price">{{ card.price_label }}</span>
                  {% endif %}
                </h4>

                {% if card.description %}
                <p class="sf-card-text">{{ card.description }}</p>
                {% endif %}

                {% if card.buy_url %}
                <a href="{{ card.buy_url }}" target="_blank" rel="noopener"
                  class="btn btn-sm btn-primary storefront-preview-card-button">
                  Buy now
                </a>
                {% endif %}
              </article>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <p class="sf-layout-editor-hint text-muted">
        Draft layout editor — drag and resize blocks. (Saving will be added next.)
      </p>
    </div>
  </div>
</div>

<script>
/*
  Storefront layout editor (drag + resize + basic text styling)
  ------------------------------------------------------------
  Notes for future reference:
  - We convert marked nodes ([data-sf-block]) into absolutely positioned blocks.
  - Selected block is highlighted and always brought on top while interacting.
  - Page background picker changes the editor “page” background (surface), not the block.
  - Links/buttons inside the editor are disabled to prevent accidental navigation.
*/

(function () {
  const editor = document.getElementById("sf-layout-editor");
  if (!editor) return;

  const openBtn = document.getElementById("sf-open-layout-editor");
  const closeBtn = document.getElementById("sf-close-layout-editor");
  const backdrop = document.getElementById("sf-layout-editor-backdrop");

  const canvas = document.getElementById("sf-editor-canvas");
  const surface = document.getElementById("sf-editor-surface");
  const content = document.getElementById("sf-editor-content");

  const fontSelect = document.getElementById("sf-font-family");
  const sizeInput  = document.getElementById("sf-font-size");
  const boldBtn    = document.getElementById("sf-font-bold");
  const italicBtn  = document.getElementById("sf-font-italic");
  const underBtn   = document.getElementById("sf-font-underline");
  const bgInput    = document.getElementById("sf-bg-color");

  const fitBtn     = document.getElementById("sf-fit-toggle");
  const hideBtn    = document.getElementById("sf-hide-block");
  const resetBtn   = document.getElementById("sf-reset-block");

  // Storage keys (scoped per page)
  const KEY_LAYOUT = "sf_layout_v2:" + location.pathname;
  const KEY_STYLES = "sf_styles_v2:" + location.pathname;
  const KEY_BG     = "sf_bg_v2:" + location.pathname;

  function readJSON(key, fallback) {
    try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
    catch (e) { return fallback; }
  }

  function writeJSON(key, value) {
    try { localStorage.setItem(key, JSON.stringify(value)); }
    catch (e) { /* ignore */ }
  }

  // Internal state
  let zCounter = 10;
  let selectedId = null;
  let fitEnabled = false;

  // Maps blockId -> DOM block element
  const blocks = new Map();

  function openEditor() {
    editor.setAttribute("aria-hidden", "false");
    editor.classList.add("is-open");
    document.body.classList.add("sf-editor-lock");

    // Build blocks once per open (safe rebuild)
    rebuildBlocks();
  }

  function closeEditor() {
    editor.setAttribute("aria-hidden", "true");
    editor.classList.remove("is-open");
    document.body.classList.remove("sf-editor-lock");

    // Clear selection so toolbar disables
    selectBlock(null);
  }

  if (openBtn) openBtn.addEventListener("click", openEditor);
  if (closeBtn) closeBtn.addEventListener("click", closeEditor);
  if (backdrop) backdrop.addEventListener("click", closeEditor);

  // Disable navigation / button actions inside editor page
  surface.addEventListener("click", function (e) {
    const a = e.target.closest("a");
    const btn = e.target.closest("button");
    if (a || btn) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, true);

  function rebuildBlocks() {
    // Remove old blocks
    blocks.forEach((el) => el.remove());
    blocks.clear();

    // Restore normal flow content (in case it was modified)
    // (We keep content as the visual reference; blocks will be overlays.)
    const marked = content.querySelectorAll("[data-sf-block]");
    if (!marked.length) return;

    // Apply saved page background
    const savedBg = localStorage.getItem(KEY_BG);
    if (savedBg) {
      surface.style.background = savedBg;
      bgInput.value = savedBg;
    } else {
      surface.style.background = "#ffffff";
    }

    // Load saved layout + styles
    const savedLayout = readJSON(KEY_LAYOUT, {});
    const savedStyles = readJSON(KEY_STYLES, {});

    // Compute positions based on current rendered positions
    const surfaceRect = surface.getBoundingClientRect();

    marked.forEach((node) => {
      const id = node.getAttribute("data-sf-block");
      const label = node.getAttribute("data-sf-label") || id;

      const rect = node.getBoundingClientRect();

      // Base size from node, then add 15% “breathing room”
      const baseW = rect.width;
      const baseH = rect.height;
      const padW = Math.max(20, baseW * 0.15);  // 10–20% feel
      const padH = Math.max(16, baseH * 0.20);

      const defaultX = rect.left - surfaceRect.left;
      const defaultY = rect.top  - surfaceRect.top;

      const layout = savedLayout[id] || {
        x: Math.max(0, defaultX),
        y: Math.max(0, defaultY),
        w: Math.min(surfaceRect.width - 20, baseW + padW),
        h: baseH + padH
      };

      // Create overlay block
      const block = document.createElement("div");
      block.className = "sf-layout-block";
      block.setAttribute("data-block-id", id);
      block.style.left = layout.x + "px";
      block.style.top  = layout.y + "px";
      block.style.width  = layout.w + "px";
      block.style.height = layout.h + "px";
      block.style.zIndex = (++zCounter).toString();

      // Label
      const labelEl = document.createElement("div");
      labelEl.className = "sf-layout-block-label";
      labelEl.textContent = label;

      // Content clone (so the block matches what user sees)
      const contentWrap = document.createElement("div");
      contentWrap.className = "sf-layout-block-content";
      contentWrap.appendChild(node.cloneNode(true));

      // Apply saved styles for this block
      const st = savedStyles[id] || {};
      if (st.fontFamily) contentWrap.style.fontFamily = st.fontFamily;
      if (st.fontSize) contentWrap.style.fontSize = st.fontSize + "px";
      if (st.bold) contentWrap.style.fontWeight = "700";
      if (st.italic) contentWrap.style.fontStyle = "italic";
      if (st.underline) contentWrap.style.textDecoration = "underline";
      if (st.hidden) block.classList.add("sf-layout-block-hidden");

      // Resize handle
      const handle = document.createElement("div");
      handle.className = "sf-layout-resize-handle";
      handle.title = "Resize";

      block.appendChild(labelEl);
      block.appendChild(contentWrap);
      block.appendChild(handle);
      surface.appendChild(block);

      blocks.set(id, block);

      // Select on click
      block.addEventListener("pointerdown", (e) => {
        // Clicking the resize handle should not start dragging
        if (e.target === handle) return;
        selectBlock(id);
        startDrag(e, block);
      });

      handle.addEventListener("pointerdown", (e) => {
        e.stopPropagation();
        selectBlock(id);
        startResize(e, block);
      });
    });

    // If we previously had a selected block, reselect it
    if (selectedId && blocks.has(selectedId)) {
      selectBlock(selectedId);
    } else {
      selectBlock(null);
    }
  }

  function selectBlock(id) {
    selectedId = id;

    // Visual highlight + toolbar enable/disable
    blocks.forEach((block) => block.classList.remove("sf-layout-block-selected"));
    if (id && blocks.has(id)) {
      const block = blocks.get(id);
      block.classList.add("sf-layout-block-selected");
      block.style.zIndex = (++zCounter).toString();

      hideBtn.disabled = false;
      resetBtn.disabled = false;

      // Sync toolbar values from stored styles
      const savedStyles = readJSON(KEY_STYLES, {});
      const st = savedStyles[id] || {};

      fontSelect.value = st.fontFamily || "";
      sizeInput.value  = st.fontSize ? String(st.fontSize) : "";

      boldBtn.classList.toggle("is-active", !!st.bold);
      italicBtn.classList.toggle("is-active", !!st.italic);
      underBtn.classList.toggle("is-active", !!st.underline);
    } else {
      hideBtn.disabled = true;
      resetBtn.disabled = true;

      fontSelect.value = "";
      sizeInput.value = "";

      boldBtn.classList.remove("is-active");
      italicBtn.classList.remove("is-active");
      underBtn.classList.remove("is-active");
    }
  }

  function saveLayoutFromBlock(block) {
    const id = block.getAttribute("data-block-id");
    const saved = readJSON(KEY_LAYOUT, {});
    saved[id] = {
      x: parseFloat(block.style.left) || 0,
      y: parseFloat(block.style.top) || 0,
      w: parseFloat(block.style.width) || 300,
      h: parseFloat(block.style.height) || 120
    };
    writeJSON(KEY_LAYOUT, saved);
  }

  function updateStyleForSelected(patch) {
    if (!selectedId) return;

    const saved = readJSON(KEY_STYLES, {});
    const current = saved[selectedId] || {};
    saved[selectedId] = { ...current, ...patch };
    writeJSON(KEY_STYLES, saved);

    // Apply immediately
    const block = blocks.get(selectedId);
    if (!block) return;

    const contentWrap = block.querySelector(".sf-layout-block-content");
    if (!contentWrap) return;

    const st = saved[selectedId];

    contentWrap.style.fontFamily = st.fontFamily || "";
    contentWrap.style.fontSize = st.fontSize ? (st.fontSize + "px") : "";

    contentWrap.style.fontWeight = st.bold ? "700" : "";
    contentWrap.style.fontStyle = st.italic ? "italic" : "";
    contentWrap.style.textDecoration = st.underline ? "underline" : "";

    block.classList.toggle("sf-layout-block-hidden", !!st.hidden);

    // Keep toolbar toggles in sync
    boldBtn.classList.toggle("is-active", !!st.bold);
    italicBtn.classList.toggle("is-active", !!st.italic);
    underBtn.classList.toggle("is-active", !!st.underline);
  }

  // Toolbar events
  fontSelect.addEventListener("change", () => {
    if (!selectedId) return;
    updateStyleForSelected({ fontFamily: fontSelect.value });
  });

  sizeInput.addEventListener("input", () => {
    if (!selectedId) return;

    const n = parseInt(sizeInput.value, 10);
    if (Number.isFinite(n) && n > 0) {
      updateStyleForSelected({ fontSize: n });
    } else if (sizeInput.value === "") {
      updateStyleForSelected({ fontSize: null });
    }
  });

  boldBtn.addEventListener("click", () => {
    if (!selectedId) return;
    const saved = readJSON(KEY_STYLES, {});
    const st = saved[selectedId] || {};
    updateStyleForSelected({ bold: !st.bold });
  });

  italicBtn.addEventListener("click", () => {
    if (!selectedId) return;
    const saved = readJSON(KEY_STYLES, {});
    const st = saved[selectedId] || {};
    updateStyleForSelected({ italic: !st.italic });
  });

  underBtn.addEventListener("click", () => {
    if (!selectedId) return;
    const saved = readJSON(KEY_STYLES, {});
    const st = saved[selectedId] || {};
    updateStyleForSelected({ underline: !st.underline });
  });

  bgInput.addEventListener("input", () => {
    const color = bgInput.value;
    surface.style.background = color;
    localStorage.setItem(KEY_BG, color);
  });

  hideBtn.addEventListener("click", () => {
    if (!selectedId) return;
    const saved = readJSON(KEY_STYLES, {});
    const st = saved[selectedId] || {};
    updateStyleForSelected({ hidden: !st.hidden });
  });

  resetBtn.addEventListener("click", () => {
    if (!selectedId) return;
    const saved = readJSON(KEY_STYLES, {});
    delete saved[selectedId];
    writeJSON(KEY_STYLES, saved);
    updateStyleForSelected({ fontFamily: "", fontSize: null, bold: false, italic: false, underline: false, hidden: false });
  });

  fitBtn.addEventListener("click", () => {
    fitEnabled = !fitEnabled;
    surface.classList.toggle("sf-surface-fit", fitEnabled);

    // When switching modes, rebuild positions from current view
    rebuildBlocks();
  });

  function startDrag(e, block) {
    e.preventDefault();
    block.classList.add("sf-layout-block--dragging");
    block.style.zIndex = (++zCounter).toString();

    const startX = e.clientX;
    const startY = e.clientY;

    const startLeft = parseFloat(block.style.left) || 0;
    const startTop  = parseFloat(block.style.top) || 0;

    block.setPointerCapture(e.pointerId);

    function onMove(ev) {
      const dx = ev.clientX - startX;
      const dy = ev.clientY - startY;

      // Keep within surface bounds (light clamp)
      const newLeft = Math.max(0, startLeft + dx);
      const newTop  = Math.max(0, startTop + dy);

      block.style.left = newLeft + "px";
      block.style.top  = newTop + "px";
    }

    function onUp(ev) {
      block.classList.remove("sf-layout-block--dragging");
      block.releasePointerCapture(ev.pointerId);

      block.removeEventListener("pointermove", onMove);
      block.removeEventListener("pointerup", onUp);

      saveLayoutFromBlock(block);
    }

    block.addEventListener("pointermove", onMove);
    block.addEventListener("pointerup", onUp);
  }

  function startResize(e, block) {
    e.preventDefault();
    block.classList.add("sf-layout-block--resizing");
    block.style.zIndex = (++zCounter).toString();

    const startX = e.clientX;
    const startY = e.clientY;

    const startW = parseFloat(block.style.width) || 320;
    const startH = parseFloat(block.style.height) || 140;

    block.setPointerCapture(e.pointerId);

    function onMove(ev) {
      const dx = ev.clientX - startX;
      const dy = ev.clientY - startY;

      const newW = Math.max(200, startW + dx);
      const newH = Math.max(80,  startH + dy);

      block.style.width = newW + "px";
      block.style.height = newH + "px";
    }

    function onUp(ev) {
      block.classList.remove("sf-layout-block--resizing");
      block.releasePointerCapture(ev.pointerId);

      block.removeEventListener("pointermove", onMove);
      block.removeEventListener("pointerup", onUp);

      saveLayoutFromBlock(block);
    }

    block.addEventListener("pointermove", onMove);
    block.addEventListener("pointerup", onUp);
  }

  // ESC closes editor (nice UX)
  document.addEventListener("keydown", function (e) {
    if (!editor.classList.contains("is-open")) return;
    if (e.key === "Escape") closeEditor();
  });
})();
</script>

{% endblock %}
