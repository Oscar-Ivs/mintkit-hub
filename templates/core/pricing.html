{% extends "base.html" %}

{% block main_class %}page-container mk-watermark{% endblock %}

{% block content %}
{% with current_billing=billing|default:"monthly" %}

<header class="mk-page-head d-flex justify-content-between align-items-start flex-wrap gap-4">
  <div>
    <h1 class="mk-page-title">Pricing</h1>

    <div class="alert alert-info mt-3" role="alert">
      <ul class="mb-0">
        <li><strong>Studio</strong> is an external companion app (beta). The Hub works independently even while Studio features are evolving.</li>
      </ul>
    </div>

    <p class="mk-page-lead">
      MintKit Hub starts with a short <strong>free trial</strong>, then an affordable <strong>Basic</strong> plan.
      A more advanced <strong>Pro</strong> tier is planned for the future.
    </p>

    <p class="mk-muted small mb-0">
      <strong>Note:</strong> MintKit Studio is currently in beta. Plan limits (collections / batch sizes) will be
      enforced once Hub ↔ Studio syncing is enabled. Until then, new users can create unlimited collections.
    </p>
  </div>

  <div class="text-end">
    {% if user.is_authenticated %}

      {% if has_active_paid %}
        <div class="text-muted small" style="margin-bottom: 10px;">
          Plan active: {{ active_plan_name }}
        </div>
        <a href="{% url 'studio' %}" class="btn btn-primary btn-sm text-nowrap">
          Open MintKit Studio
        </a>

      {% elif trial_active %}
        <div class="text-muted small" style="margin-bottom: 14px;">
          Trial active
          {% if trial_end %}— ends on {{ trial_end|date:"F j, Y" }}{% endif %}
        </div>
        <a href="{% url 'studio' %}" class="btn btn-primary btn-sm">
          Open MintKit Studio
        </a>

      {% elif trial_expired %}
        <div class="text-muted small" style="margin-bottom: 14px;">
          Trial already used
          {% if trial_end %}— ended on {{ trial_end|date:"F j, Y" }}{% endif %}
        </div>
        <a href="{% url 'subscriptions_checkout' 'basic' %}?billing={{ current_billing }}"
           class="btn btn-primary btn-sm js-billing-link">
          Upgrade to Basic
        </a>

      {% else %}
        <div class="text-muted small" style="margin-bottom: 14px;">
          Eligible for free trial
        </div>
        <a href="{% url 'start_trial' %}" class="btn btn-primary btn-sm">
          Start free trial
        </a>
      {% endif %}

    {% else %}
      <div class="text-muted small" style="margin-bottom: 14px;">
        Log in to start a free trial
      </div>
      <a href="{% url 'login' %}" class="btn btn-primary btn-sm">
        Log in
      </a>
    {% endif %}
  </div>
</header>

<section class="mk-pricing" aria-label="Plans">

  {# IMPORTANT: input must be a sibling BEFORE .mk-billing-row and .mk-pricing-grid for your CSS to work #}
  <input class="mk-billing-toggle"
         type="checkbox"
         id="mk-billing-toggle"
         {% if current_billing == "annual" %}checked{% endif %}>

  <div class="mk-billing-row">
    <div class="mk-billing-left">
      <span class="mk-billing-label">Annual pricing</span>
      <span class="mk-save-pill">Save 20%</span>

      <label class="mk-switch mb-0" for="mk-billing-toggle">
        <span class="sr-only"
              style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;">
          Toggle annual pricing
        </span>
        <span class="mk-switch-track"></span>
        <span class="mk-switch-thumb"></span>
      </label>
    </div>
  </div>

  <div class="mk-pricing-grid">

    <!-- Free Trial -->
    <article class="mk-plan-card">
      <h2 class="mk-plan-name">Free Trial</h2>
      <p class="mk-plan-sub">Try MintKit Hub with core features enabled.</p>

      <div class="mk-price">
        <span class="mk-price-amount">£0</span>
        <span class="mk-price-term">for 14 days</span>
      </div>

      {% if user.is_authenticated %}
        {% if has_active_paid %}
          <span class="btn btn-primary mk-plan-btn disabled" aria-disabled="true" tabindex="-1">
            Not available (plan active)
          </span>
        {% elif trial_active %}
          <span class="btn btn-primary mk-plan-btn disabled" aria-disabled="true" tabindex="-1">
            Trial active
          </span>
        {% elif trial_expired %}
          <span class="btn btn-primary mk-plan-btn disabled" aria-disabled="true" tabindex="-1">
            Trial used
          </span>
        {% else %}
          <a class="btn btn-primary mk-plan-btn" href="{% url 'start_trial' %}">
            Start trial
          </a>
        {% endif %}
      {% else %}
        <a class="btn btn-primary mk-plan-btn" href="{% url 'login' %}">
          Log in to start
        </a>
      {% endif %}

      <ul class="mk-feature-list">
        <li class="mk-feature mk-feature--on">Full access to MintKit Hub dashboard</li>
        <li class="mk-feature mk-feature--on">Set up business profile and storefront</li>
        <li class="mk-feature mk-feature--on">Connect Stripe (test mode for this project)</li>
        <li class="mk-feature mk-feature--on">Create a small set of gift cards / tickets / vouchers</li>
        <li class="mk-feature">
          Collections: <strong>Unlimited</strong> <span class="text-muted small">(beta access)</span>
        </li>
        <li class="mk-feature">
          Batch size: <strong>Flexible</strong> <span class="text-muted small">(limits enforced later)</span>
        </li>
      </ul>

      <p class="mk-plan-footnote">
        Planned caps (when gating goes live): Trial up to <strong>3 collections</strong>.
      </p>
    </article>

    <!-- Basic (Recommended) -->
    <article class="mk-plan-card mk-plan-card--recommended" aria-label="Basic plan (recommended)">
      <div class="mk-reco-pill">RECOMMENDED</div>

      <h2 class="mk-plan-name">Basic</h2>
      <p class="mk-plan-sub">For small businesses starting to sell digital cards.</p>

      <div class="mk-price mk-price--dual">
        <span class="mk-price-monthly">
          <span class="mk-price-amount">£6.99</span>
          <span class="mk-price-term">/ month</span>
        </span>

        <span class="mk-price-annual">
          <span class="mk-price-amount">£67.10</span>
          <span class="mk-price-term">/ year</span>
          <small class="mk-price-meta">Equivalent ~ £5.59/mo</small>
        </span>
      </div>

      {% if not user.is_authenticated %}
        <a class="btn btn-primary mk-plan-btn" href="{% url 'login' %}">
          Log in to upgrade
        </a>
      {% elif has_active_paid %}
        <a class="btn btn-primary mk-plan-btn" href="{% url 'subscriptions_billing_portal' %}">
          Manage subscription
        </a>
      {% else %}
        <a class="btn btn-primary mk-plan-btn js-billing-link"
           href="{% url 'subscriptions_checkout' 'basic' %}?billing={{ current_billing }}">
          Upgrade
        </a>
      {% endif %}

      <ul class="mk-feature-list">
        <li class="mk-feature mk-feature--on">Everything in the Free Trial</li>
        <li class="mk-feature mk-feature--on">Live (non-trial) access to MintKit Studio</li>
        <li class="mk-feature mk-feature--on">Higher minting allowance for real customers</li>
        <li class="mk-feature mk-feature--on">
          Collections: <strong>Unlimited</strong> <span class="text-muted small">(beta access)</span>
        </li>
        <li class="mk-feature mk-feature--on">
          Active cards: <strong>Flexible</strong> <span class="text-muted small">(limits enforced later)</span>
        </li>
        <li class="mk-feature mk-feature--on">Email support with reasonable response time</li>
      </ul>

      <p class="mk-plan-footnote">
        Planned caps (when gating goes live): Basic up to <strong>5 collections</strong>.
      </p>
    </article>

    <!-- Pro (Coming soon) -->
    <article class="mk-plan-card mk-plan-card--muted">
      <h2 class="mk-plan-name">Pro</h2>
      <p class="mk-plan-sub">Coming soon — for larger businesses and teams.</p>

      <div class="mk-price mk-price--dual">
        <span class="mk-price-monthly">
          <span class="mk-price-amount">£9.99</span>
          <span class="mk-price-term">/ month</span>
        </span>

        <span class="mk-price-annual">
          <span class="mk-price-amount">£95.90</span>
          <span class="mk-price-term">/ year</span>
          <small class="mk-price-meta">Equivalent ~ £7.99/mo</small>
        </span>
      </div>

      <span class="btn btn-outline-primary mk-plan-btn disabled" aria-disabled="true" tabindex="-1">
        Coming soon
      </span>

      <ul class="mk-feature-list">
        <li class="mk-feature mk-feature--on">Higher card limits (example 250 active cards)</li>
        <li class="mk-feature mk-feature--on">Larger batch sizes for busy businesses</li>
        <li class="mk-feature mk-feature--on">Priority support and faster response times</li>
        <li class="mk-feature mk-feature--on">Richer analytics as sales grow</li>
        <li class="mk-feature mk-feature--on">Advanced tools (promo codes, redemption options)</li>
      </ul>

      <p class="mk-plan-footnote">
        Shown for roadmap purposes — not implemented in this project.
      </p>
    </article>

  </div>
</section>

<section class="mk-pricing-notes" aria-label="Notes">
  <h2 class="mk-section-title">Notes for this college project</h2>
  <p class="mk-muted">
    The pricing and limits above explain how MintKit Hub could work as a real SaaS product.
    Currently, MintKit Studio does not yet read subscription limits from the Hub — those caps will be enabled later.
  </p>

  <ul class="mk-bullet">
    <li>Account &amp; profile management</li>
    <li>Storefront creation and public view</li>
    <li>Basic subscription structure and trial concept</li>
    <li>Linking to the external MintKit Studio application</li>
  </ul>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const toggle = document.getElementById("mk-billing-toggle");
  if (!toggle) return;

  function setBilling(billing) {
    // Update address bar without refreshing the page
    try {
      const url = new URL(window.location.href);
      url.searchParams.set("billing", billing);
      window.history.replaceState({}, "", url);
    } catch (e) {}

    // Update any checkout links that must carry billing=...
    document.querySelectorAll(".js-billing-link").forEach(function (a) {
      try {
        const u = new URL(a.getAttribute("href"), window.location.origin);
        u.searchParams.set("billing", billing);
        a.setAttribute("href", u.pathname + u.search + u.hash);
      } catch (e) {}
    });
  }

  setBilling(toggle.checked ? "annual" : "monthly");

  toggle.addEventListener("change", function () {
    setBilling(toggle.checked ? "annual" : "monthly");
  });
});
</script>

{% endwith %}
{% endblock %}
